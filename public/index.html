<!DOCTYPE html>
<!-- All  this code was generated by google IA (Gemini) -->
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clash of Clans - Player Comparison</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div id="dashboards" class="dashboard-container">
      <p id="loading-message" class="info-message">Loading player data...</p>
    </div>

    <script>
      (async () => {
        const container = document.getElementById("dashboards");
        const loadingMessage = document.getElementById("loading-message");

        loadingMessage.style.display = "block";
        container.innerHTML = "";

        const players = [
          { name: "Tony Stark", tag: "#Y9PQCJ02L" },
          { name: "tvl", tag: "#22QCVQ8Y" },
        ];

        try {
          const fetchPromises = players.map((player) =>
            axios
              .get(
                `https://coc.lourenco-jplm1818.workers.dev/?id=${player.name}`
              )
              .then((response) => ({ name: player.name, data: response.data }))
          );

          const results = await Promise.all(fetchPromises);

          loadingMessage.style.display = "none";

          const playerTony = results.find(
            (p) => p.name.toLowerCase() === "tony stark"
          )?.data;
          const playerTVL = results.find(
            (p) => p.name.toLowerCase() === "tvl"
          )?.data;

          if (!playerTony || !playerTVL) {
            container.innerHTML = `
              <p class="error-message">
                Error: Could not retrieve complete data for Tony Stark or TVL.
                Please check if player names are correct or if data is available.
              </p>
            `;
            return;
          }

          const comparisonCategories = ["troops", "spells", "heroes"];
          const comparisonData = {};

          for (const category of comparisonCategories) {
            const tonyItems = playerTony[category] || [];
            const tvlItems = playerTVL[category] || [];

            const itemNames = new Set([
              ...tonyItems.map((i) => i.name),
              ...tvlItems.map((i) => i.name),
            ]);

            comparisonData[category] = [];

            for (const itemName of itemNames) {
              const tonyItem = tonyItems.find((i) => i.name === itemName);
              const tvlItem = tvlItems.find((i) => i.name === itemName);

              const tonyLevel = tonyItem?.level || 0;
              const tvlLevel = tvlItem?.level || 0;
              const maxLevel = Math.max(
                tonyItem?.maxLevel || 0,
                tvlItem?.maxLevel || 0
              );

              let winner = "draw";
              if (tonyLevel > tvlLevel) {
                winner = "tony";
              } else if (tvlLevel > tonyLevel) {
                winner = "tvl";
              }

              const tonyIsMax = tonyLevel > 0 && tonyLevel === maxLevel;
              const tvlIsMax = tvlLevel > 0 && tvlLevel === maxLevel;
              const itemIsMax =
                tonyLevel === maxLevel && tvlLevel === maxLevel && maxLevel > 0;

              comparisonData[category].push({
                name: itemName,
                tonyLevel: tonyLevel,
                tvlLevel: tvlLevel,
                maxLevel: maxLevel,
                winner: winner,
                tonyIsMax: tonyIsMax,
                tvlIsMax: tvlIsMax,
                itemIsMax: itemIsMax,
              });
            }
          }

          // --- Functions to Generate HTML Sections ---

          const createComparisonTableSection = (
            title,
            icon,
            list,
            player1Name,
            player2Name
          ) => {
            return `
              <h3>${icon} ${title}</h3>
              <table class="compare-table">
                <thead>
                  <tr>
                    <th>${player1Name}</th>
                    <th>Item</th>
                    <th>${player2Name}</th>
                  </tr>
                </thead>
                <tbody>
                  ${list
                    .map((item) => {
                      let classTony = "",
                        classTVL = "";
                      let itemDisplayName = item.name;

                      if (item.itemIsMax) {
                        itemDisplayName = `${item.name} üî•`;
                      }

                      if (item.winner === "tony") {
                        classTony = "highlight-green";
                        classTVL = "highlight-red";
                      } else if (item.winner === "tvl") {
                        classTony = "highlight-red";
                        classTVL = "highlight-green";
                      } else {
                        classTony = classTVL = "highlight-blue";
                      }

                      const tonyPulseClass = item.tonyIsMax
                        ? "max-level-pulse"
                        : "";
                      const tvlPulseClass = item.tvlIsMax
                        ? "max-level-pulse"
                        : "";

                      const tonyLevelDisplay = `Level ${item.tonyLevel} / ${item.maxLevel}`;
                      const tvlLevelDisplay = `Level ${item.tvlLevel} / ${item.maxLevel}`;

                      const tonyProgressBar =
                        item.tonyLevel < item.maxLevel && item.maxLevel > 0
                          ? `<progress class="level-progress" value="${item.tonyLevel}" max="${item.maxLevel}"></progress>`
                          : "";
                      const tvlProgressBar =
                        item.tvlLevel < item.maxLevel && item.maxLevel > 0
                          ? `<progress class="level-progress" value="${item.tvlLevel}" max="${item.maxLevel}"></progress>`
                          : "";

                      return `
                        <tr>
                          <td class="${classTony} ${tonyPulseClass}">
                            <div class="level-info-wrapper">
                                ${tonyLevelDisplay}
                                ${tonyProgressBar}
                            </div>
                          </td>
                          <td>${itemDisplayName}</td>
                          <td class="${classTVL} ${tvlPulseClass}">
                            <div class="level-info-wrapper">
                                ${tvlLevelDisplay}
                                ${tvlProgressBar}
                            </div>
                          </td>
                        </tr>`;
                    })
                    .join("")}
                </tbody>
              </table>
            `;
          };

          const createHeroEquipmentSection = (equipment, playerName) => {
            if (!equipment || equipment.length === 0) {
              return `<p class="info-message">No hero equipment found for ${playerName}.</p>`;
            }
            let equipmentList = equipment
              .map((equip) => {
                const progressBar =
                  equip.level < equip.maxLevel && equip.maxLevel > 0
                    ? `<progress class="level-progress-compact" value="${equip.level}" max="${equip.maxLevel}"></progress>`
                    : "";
                const isMaxPulseClass =
                  equip.level > 0 && equip.level === equip.maxLevel
                    ? "max-level-pulse-compact"
                    : "";

                return `
                <tr>
                  <td class="${isMaxPulseClass}">
                    ${equip.name}
                    <br>
                    Level ${equip.level} / ${equip.maxLevel}
                    ${progressBar}
                  </td>
                </tr>
              `;
              })
              .join("");

            return `
              <div class="player-details-card">
                <h4>Hero Equipment</h4>
                <table class="compact-table">
                  <tbody>
                    ${equipmentList}
                  </tbody>
                </table>
              </div>
            `;
          };

          const createAchievementsSection = (
            achievements,
            playerName,
            villageType = "home"
          ) => {
            const filteredAchievements = achievements.filter(
              (a) => a.village === villageType
            );
            const topCompleted = filteredAchievements
              .filter((a) => a.stars === 3)
              .slice(0, 5);
            const topUncompleted = filteredAchievements
              .filter((a) => a.stars < 3)
              .slice(0, 5);

            let achievementList = [...topCompleted, ...topUncompleted]
              .map((achievement) => {
                // Note: Achievement progress might not always be 'level' like troops/heroes.
                // 'value' vs 'target' fields are more appropriate for achievements.
                // Assuming 'target' is like maxLevel and 'value' is current progress.
                const completionValue = achievement.value || 0;
                const completionTarget = achievement.target || 1; // Default to 1 to avoid division by zero

                const progressBar =
                  completionValue < completionTarget && completionTarget > 0
                    ? `<progress class="level-progress-compact" value="${completionValue}" max="${completionTarget}"></progress>`
                    : "";

                // Achievement is "max" if it has 3 stars
                const isMaxPulseClass =
                  achievement.stars === 3 ? "max-level-pulse-compact" : "";

                return `
                <tr>
                  <td class="${isMaxPulseClass}">
                    ${achievement.name}
                    <br>
                    Stars: ${achievement.stars} / ${
                  achievement.targetStars || 3
                }
                    ${progressBar}
                  </td>
                </tr>
              `;
              })
              .join("");

            if (!achievementList) {
              return `<p class="info-message">No achievements found for ${playerName}.</p>`;
            }

            return `
              <div class="player-details-card">
                <h4>${
                  villageType === "home"
                    ? "Home Village Achievements"
                    : "Builder Base Achievements"
                }</h4>
                <table class="compact-table">
                  <tbody>
                    ${achievementList}
                  </tbody>
                </table>
              </div>
            `;
          };

          const createLabelsSection = (labels, playerName) => {
            if (!labels || labels.length === 0) {
              return `<p class="info-message">No labels found for ${playerName}.</p>`;
            }
            let labelList = labels
              .map(
                (label) => `
              <tr>
                <td>${label.name}</td>
                <td><img src="${label.iconUrls.small}" alt="${label.name}" class="label-icon" /></td>
              </tr>
            `
              )
              .join("");

            return `
              <div class="player-details-card">
                <h4>Labels</h4>
                <table class="compact-table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Icon</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${labelList}
                  </tbody>
                </table>
              </div>
            `;
          };

          const createClanDetailsSection = (clan, playerName) => {
            if (!clan) {
              return `<p class="info-message">${playerName} does not belong to a clan.</p>`;
            }
            return `
              <div class="player-details-card">
                <h4>Clan</h4>
                <p><strong>Name:</strong> ${clan.name || "N/A"}</p>
                <p><strong>Level:</strong> ${clan.clanLevel || "N/A"}</p>
                ${
                  clan.badgeUrls
                    ? `<img src="${clan.badgeUrls.small}" alt="Clan Badge" class="clan-badge" />`
                    : ""
                }
              </div>
            `;
          };

          const createLeagueDetailsSection = (league, playerName) => {
            if (!league) {
              return `<p class="info-info">No league found for ${playerName}.</p>`;
            }
            return `
              <div class="player-details-card">
                <h4>Main League</h4>
                <p><strong>Name:</strong> ${league.name || "N/A"}</p>
                ${
                  league.iconUrls
                    ? `<img src="${league.iconUrls.small}" alt="League Icon" class="league-icon" />`
                    : ""
                }
              </div>
            `;
          };

          const createBuilderBaseLeagueDetailsSection = (
            builderBaseLeague,
            playerName
          ) => {
            if (!builderBaseLeague) {
              return `<p class="info-message">${playerName} is not in any Builder Base league.</p>`;
            }
            return `
              <div class="player-details-card">
                <h4>Builder Base League</h4>
                <p><strong>Name:</strong> ${builderBaseLeague.name || "N/A"}</p>
              </div>
            `;
          };

          // --- Functions to Generate Charts with Chart.js ---
          const renderChart = (ctx, type, data, options) => {
            new Chart(ctx, {
              type: type,
              data: data,
              options: options,
            });
          };

          const generateLevelChartData = (
            categoryData,
            player1Name,
            player2Name
          ) => {
            const labels = categoryData.map((item) => {
              return item.itemIsMax ? `${item.name} üî•` : item.name;
            });
            const tonyLevels = categoryData.map((item) => item.tonyLevel);
            const tvlLevels = categoryData.map((item) => item.tvlLevel);
            const maxLevels = categoryData.map((item) => item.maxLevel);

            const datasets = [
              {
                label: `${player1Name} Current Level`,
                data: tonyLevels,
                backgroundColor: categoryData.map((item) =>
                  item.tonyIsMax
                    ? "rgba(255, 215, 0, 0.9)"
                    : "rgba(102, 255, 204, 0.9)"
                ),
                borderColor: categoryData.map((item) =>
                  item.tonyIsMax
                    ? "rgba(255, 215, 0, 1)"
                    : "rgba(102, 255, 204, 1)"
                ),
                borderWidth: 1,
                stack: "tonyStack",
              },
              {
                label: `${player1Name} To Max`,
                data: tonyLevels.map((level, i) => maxLevels[i] - level),
                backgroundColor: "rgba(102, 255, 204, 0.3)",
                borderColor: "rgba(102, 255, 204, 0.5)",
                borderWidth: 1,
                stack: "tonyStack",
              },
              {
                label: `${player2Name} Current Level`,
                data: tvlLevels,
                backgroundColor: categoryData.map((item) =>
                  item.tvlIsMax
                    ? "rgba(255, 215, 0, 0.9)"
                    : "rgba(255, 170, 170, 0.9)"
                ),
                borderColor: categoryData.map((item) =>
                  item.tvlIsMax
                    ? "rgba(255, 215, 0, 1)"
                    : "rgba(255, 170, 170, 1)"
                ),
                borderWidth: 1,
                stack: "tvlStack",
              },
              {
                label: `${player2Name} To Max`,
                data: tvlLevels.map((level, i) => maxLevels[i] - level),
                backgroundColor: "rgba(255, 170, 170, 0.3)",
                borderColor: "rgba(255, 170, 170, 0.5)",
                borderWidth: 1,
                stack: "tvlStack",
              },
            ];

            const maxOverallLevel = Math.max(...maxLevels);

            const options = {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  labels: {
                    color: "#f0f0f0",
                    filter: function (item, chart) {
                      return !item.text.includes("To Max");
                    },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const itemIndex = context.dataIndex;
                      const dataLabel = context.dataset.label || "";
                      const currentLevelValue = context.parsed.y;
                      const itemName = labels[itemIndex].replace(" üî•", "");
                      const maxLevelForThisItem = maxLevels[itemIndex];

                      if (dataLabel.includes("Current Level")) {
                        const isMax =
                          currentLevelValue > 0 &&
                          currentLevelValue === maxLevelForThisItem;
                        return `${itemName} (${dataLabel}): ${currentLevelValue} (Max: ${maxLevelForThisItem})${
                          isMax ? " üî•" : ""
                        }`;
                      } else if (dataLabel.includes("To Max")) {
                        return `${itemName} (${dataLabel}): ${currentLevelValue} (Total Level: ${maxLevelForThisItem})`;
                      }
                      return `${dataLabel}: ${currentLevelValue}`;
                    },
                  },
                },
              },
              scales: {
                x: {
                  stacked: false,
                  ticks: {
                    color: "#f0f0f0",
                    maxRotation: 45,
                    minRotation: 45,
                  },
                  grid: {
                    color: "#444",
                  },
                },
                y: {
                  stacked: true,
                  beginAtZero: true,
                  max: maxOverallLevel > 0 ? maxOverallLevel + 1 : 10,
                  ticks: {
                    color: "#f0f0f0",
                    stepSize: 1,
                  },
                  grid: {
                    color: "#444",
                  },
                },
              },
            };

            return { labels, datasets, options };
          };

          // Generating individual player details cards
          const tonyDetails = `
            <div class="player-individual-details">
                <h3>${playerTony.name}</h3>
                <p><strong>XP Level:</strong> üåü ${playerTony.expLevel}</p>
                <p><strong>Trophies:</strong> üèÜ ${
                  playerTony.trophies
                } (Best: ${playerTony.bestTrophies})</p>
                <p><strong>Attack Wins:</strong> ‚öîÔ∏è ${playerTony.attackWins}</p>
                <p><strong>Defense Wins:</strong> üõ°Ô∏è ${
                  playerTony.defenseWins
                }</p>
                <p><strong>War Stars:</strong> ‚≠ê ${playerTony.warStars}</p>
                <p><strong>War Preference:</strong> ${
                  playerTony.warPreference === "in"
                    ? "Participating ‚úÖ"
                    : "Not Participating ‚ùå"
                }</p>
                <p><strong>TH Weapon Level:</strong> üí• ${
                  playerTony.townHallWeaponLevel || "N/A"
                }</p>
                <p><strong>Clan Role:</strong> ü§ù ${
                  playerTony.role
                    ? playerTony.role.charAt(0).toUpperCase() +
                      playerTony.role.slice(1)
                    : "Member"
                }</p>
                <p><strong>Builder Hall Level:</strong> üè† ${
                  playerTony.builderHallLevel
                }</p>
                <p><strong>Builder Base Trophies:</strong> üèÖ ${
                  playerTony.builderBaseTrophies
                } (Best: ${playerTony.bestBuilderBaseTrophies})</p>
                <p><strong>Clan Capital Contributions:</strong> üí∞ ${
                  playerTony.clanCapitalContributions
                }</p>
                <p><strong>Donations:</strong> üéÅ ${
                  playerTony.donations
                } (Received: ${playerTony.donationsReceived})</p>
                
                <hr class="card-separator">

                ${createHeroEquipmentSection(
                  playerTony.heroEquipment,
                  playerTony.name
                )}
                ${createAchievementsSection(
                  playerTony.achievements,
                  playerTony.name,
                  "home"
                )}
                ${createAchievementsSection(
                  playerTony.achievements,
                  playerTony.name,
                  "builderBase"
                )}
                ${createLabelsSection(playerTony.labels, playerTony.name)}
                
                <hr class="card-separator">

                <div class="player-details-sub-wrapper">
                    ${createClanDetailsSection(
                      playerTony.clan,
                      playerTony.name
                    )}
                    ${createLeagueDetailsSection(
                      playerTony.league,
                      playerTony.name
                    )}
                    ${createBuilderBaseLeagueDetailsSection(
                      playerTony.builderBaseLeague,
                      playerTony.name
                    )}
                </div>
            </div>
          `;

          const tvlDetails = `
            <div class="player-individual-details">
                <h3>${playerTVL.name}</h3>
                <p><strong>XP Level:</strong> üåü ${playerTVL.expLevel}</p>
                <p><strong>Trophies:</strong> üèÜ ${playerTVL.trophies} (Best: ${
            playerTVL.bestTrophies
          })</p>
                <p><strong>Attack Wins:</strong> ‚öîÔ∏è ${playerTVL.attackWins}</p>
                <p><strong>Defense Wins:</strong> üõ°Ô∏è ${
                  playerTVL.defenseWins
                }</p>
                <p><strong>War Stars:</strong> ‚≠ê ${playerTVL.warStars}</p>
                <p><strong>War Preference:</strong> ${
                  playerTVL.warPreference === "in"
                    ? "Participating ‚úÖ"
                    : "Not Participating ‚ùå"
                }</p>
                <p><strong>TH Weapon Level:</strong> üí• ${
                  playerTVL.townHallWeaponLevel || "N/A"
                }</p>
                <p><strong>Clan Role:</strong> ü§ù ${
                  playerTVL.role
                    ? playerTVL.role.charAt(0).toUpperCase() +
                      playerTVL.role.slice(1)
                    : "Member"
                }</p>
                <p><strong>Builder Hall Level:</strong> üè† ${
                  playerTVL.builderHallLevel
                }</p>
                <p><strong>Builder Base Trophies:</strong> üèÖ ${
                  playerTVL.builderBaseTrophies
                } (Best: ${playerTVL.bestBuilderBaseTrophies})</p>
                <p><strong>Clan Capital Contributions:</strong> üí∞ ${
                  playerTVL.clanCapitalContributions
                }</p>
                <p><strong>Donations:</strong> üéÅ ${
                  playerTVL.donations
                } (Received: ${playerTVL.donationsReceived})</p>
                
                <hr class="card-separator">

                ${createHeroEquipmentSection(
                  playerTVL.heroEquipment,
                  playerTVL.name
                )}
                ${createAchievementsSection(
                  playerTVL.achievements,
                  playerTVL.name,
                  "home"
                )}
                ${createAchievementsSection(
                  playerTVL.achievements,
                  playerTVL.name,
                  "builderBase"
                )}
                ${createLabelsSection(playerTVL.labels, playerTVL.name)}
                
                <hr class="card-separator">

                <div class="player-details-sub-wrapper">
                    ${createClanDetailsSection(playerTVL.clan, playerTVL.name)}
                    ${createLeagueDetailsSection(
                      playerTVL.league,
                      playerTVL.name
                    )}
                    ${createBuilderBaseLeagueDetailsSection(
                      playerTVL.builderBaseLeague,
                      playerTVL.name
                    )}
                </div>
            </div>
          `;

          // Render the final HTML into the container
          container.innerHTML = `
            <h2>Player Comparison: ${playerTony.name} vs ${playerTVL.name}</h2>
            <p>
              <strong>${playerTony.name}</strong> (TH: ${
            playerTony.townHallLevel
          }) vs
              <strong>${playerTVL.name}</strong> (TH: ${
            playerTVL.townHallLevel
          })
            </p>
            <p>
                This dashboard compares troop, spell, and hero levels, as well as individual player details.
            </p>

            <h2>Detailed Comparison Tables</h2>
            ${createComparisonTableSection(
              "Heroes",
              "üëë",
              comparisonData.heroes,
              playerTony.name,
              playerTVL.name
            )}
            ${createComparisonTableSection(
              "Troops",
              "‚öîÔ∏è",
              comparisonData.troops,
              playerTony.name,
              playerTVL.name
            )}
            ${createComparisonTableSection(
              "Spells",
              "üßô",
              comparisonData.spells,
              playerTony.name,
              playerTVL.name
            )}

            <hr>

            <h2>Comparative Level Charts</h2>
            <div class="chart-section">
                <h3>üìà Hero Levels</h3>
                <canvas id="heroesChart"></canvas>
            </div>
            <div class="chart-section">
                <h3>‚öîÔ∏è Troop Levels</h3>
                <canvas id="troopsChart"></canvas>
            </div>
            <div class="chart-section">
                <h3>üßô Spell Levels</h3>
                <canvas id="spellsChart"></canvas>
            </div>

            <hr>

            <h2>Individual Player Details</h2>
            <div class="individual-details-wrapper">
                ${tonyDetails}
                ${tvlDetails}
            </div>
          `;

          // --- Chart Initialization ---
          setTimeout(() => {
            const heroesChartConfig = generateLevelChartData(
              comparisonData.heroes,
              playerTony.name,
              playerTVL.name
            );
            renderChart(
              document.getElementById("heroesChart"),
              "bar",
              {
                labels: heroesChartConfig.labels,
                datasets: heroesChartConfig.datasets,
              },
              heroesChartConfig.options
            );

            const troopsChartConfig = generateLevelChartData(
              comparisonData.troops,
              playerTony.name,
              playerTVL.name
            );
            renderChart(
              document.getElementById("troopsChart"),
              "bar",
              {
                labels: troopsChartConfig.labels,
                datasets: troopsChartConfig.datasets,
              },
              troopsChartConfig.options
            );

            const spellsChartConfig = generateLevelChartData(
              comparisonData.spells,
              playerTony.name,
              playerTVL.name
            );
            renderChart(
              document.getElementById("spellsChart"),
              "bar",
              {
                labels: spellsChartConfig.labels,
                datasets: spellsChartConfig.datasets,
              },
              spellsChartConfig.options
            );
          }, 100);
        } catch (err) {
          loadingMessage.style.display = "none";

          let errorMessage =
            "An unexpected error occurred while loading data. Please try again later.";

          if (axios.isAxiosError(err)) {
            if (err.response) {
              if (err.response.status === 404) {
                errorMessage =
                  "Error: One or more players not found in the API. Check IDs or names.";
              } else {
                errorMessage = `API Error (${err.response.status}): ${
                  err.response.data?.message ||
                  err.response.statusText ||
                  "Unexpected response"
                }`;
              }
            } else if (err.request) {
              errorMessage =
                "Connection error: Could not reach the API server. Check your internet connection.";
            }
          } else {
            errorMessage = `Internal error: ${err.message}`;
          }

          container.innerHTML = `<p class="error-message">${errorMessage}</p>`;
          console.error("Detailed error:", err);
        }
      })();
    </script>
  </body>
</html>
